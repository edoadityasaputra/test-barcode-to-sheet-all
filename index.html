<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presensi Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
    }

    #appContainer {
      width: 100%;
      height: 100%;
    }

    .header {
      padding: 20px;
      background: #2196F3;
      color: white;
    }

    .kelas-selector {
      margin-top: 10px;
    }

    select {
      font-size: 16px;
      padding: 8px;
      border-radius: 8px;
    }

    #reader {
      margin: 20px auto;
      width: 90%;
      max-width: 400px;
      background: #87CEFA;
      border-radius: 12px;
      padding: 10px;
    }

    #reader video {
      width: 100% !important;
      border-radius: 10px;
    }

    #result {
      margin-top: 15px;
      font-size: 18px;
    }

    .btn {
      padding: 10px 20px;
      margin: 8px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      color: white;
    }

    #kirimBtn { background: #4CAF50; }
    #batalBtn { background: #f44336; }
    #rescanBtn { background: #2196F3; }
    #uploadBtn { background: #FF9800; }

    iframe { display:none; }

    #fullscreenBtn {
      position: fixed;
      top: 10px;
      left: 10px;
      font-size: 22px;
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      z-index: 999;
    }
  </style>
</head>

<body>

<button id="fullscreenBtn"><-</button>

<div id="appContainer">
  <div class="header">
    <img src="https://edoadityasaputra.github.io/barcode-to-sheet/MI-Khoirul-Huda_C3.png"
         style="width:120px;border-radius:10px;">
    <h2>Scan Presensi Informatika</h2>
    <h3>MI Khoirul Huda Bedahan</h3>

    <div class="kelas-selector">
      <select id="kelas">
        <option value="" disabled selected>-- Pilih Kelas --</option>
        <option>4A</option><option>4B</option><option>4C</option>
        <option>5A</option><option>5B</option><option>5C</option>
        <option>6A</option><option>6B</option><option>6C</option>
      </select>
    </div>
  </div>

  <div id="reader"></div>

  <!-- üîπ UPLOAD FOTO BARCODE -->
  <input type="file" id="uploadBarcode" accept="image/*" style="display:none;">
  <button id="uploadBtn" class="btn">Upload Foto Barcode</button>

  <div id="result"></div>

  <button id="kirimBtn" class="btn" style="display:none;">Kirim</button>
  <button id="batalBtn" class="btn" style="display:none;">Batal</button>
  <button id="rescanBtn" class="btn" style="display:none;">Scan Ulang</button>

  <iframe id="formFrame"></iframe>
</div>

<script>
const scriptURLs = {
  "4A":"https://script.google.com/macros/s/AKfycbz6_AAjVPJajEmaqqHaqujf1VR6U_54uv3BUm6IyNxVNm3_RlyaEmBqWbq-G8RPkCM/exec",
  "4B":"https://script.google.com/macros/s/AKfycbwoxw-VRAr5DR4TMcSHW3-YGQmXJPKoOD7dTABAiMqHcNs51X7ltl0Y59z6VhWY_rNV/exec",
  "4C":"https://script.google.com/macros/s/AKfycbyZiLmqhzQkLPXc5bO902u2f1kbLFMp3WSmtG4gic-20VPEEP08QH-Ck_GArAY_B78dKw/exec",
  "5A":"https://script.google.com/macros/s/AKfycbww8jozYEiGYnOWYjeaGGlDQfYbF8mRp8DvXvAbIS1JJpfSmHjHZYu7SJZzZl3uSo7lZA/exec",
  "5B":"https://script.google.com/macros/s/AKfycbxh7-p2ug3CdkYt5nMT5hukggHx8csGkF8uauseDLjqrWrUyu42-EGdB5Vd9D9eGqT3kQ/exec",
  "5C":"https://script.google.com/macros/s/AKfycbzK0jKfEhMOzLNjN4DbzNkGZyAYYJYXd6vBTxzCtE3bNBGQsY-hBbN-mf2XRmqCB148/exec",
  "6A":"https://script.google.com/macros/s/AKfycbyyXmjBctPVgKiuDBpqp5ASTEKr3zg52uqnC9HlPV3BZPvRP0KSKtsxm8dlX6o_OG0TTw/exec",
  "6B":"https://script.google.com/macros/s/AKfycbwajXdwP6CfskszmMNTm3Aw8-UdHihGHZV9WQbzW4YhP2iK3r8JEOYi71wRU99Zqfyu/exec",
  "6C":"https://script.google.com/macros/s/AKfycbwhIPdvNgu4z02pQ6Q_AXjL7OQaf1VFj6p1x7wR9nQ-RUWusqYW5OFXPnGVQEOGCPbnLQ/exec"
};

let html5QrCode;
let scannedData = "";

const reader = document.getElementById("reader");
const result = document.getElementById("result");
const kirimBtn = document.getElementById("kirimBtn");
const batalBtn = document.getElementById("batalBtn");
const rescanBtn = document.getElementById("rescanBtn");
const kelas = document.getElementById("kelas");
const uploadBtn = document.getElementById("uploadBtn");
const uploadInput = document.getElementById("uploadBarcode");

function startScanner() {
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (text) => {
      scannedData = text;
      result.innerHTML = "<b>Data Terdeteksi:</b><br>" + text;
      kirimBtn.style.display = batalBtn.style.display = "inline-block";
      html5QrCode.stop();
    }
  );
}

// üîπ UPLOAD FOTO BARCODE
uploadBtn.onclick = () => uploadInput.click();

uploadInput.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;

  if (html5QrCode) html5QrCode.stop().catch(()=>{});

  result.innerHTML = "üîç Memindai foto...";
  html5QrCode = new Html5Qrcode("reader");

  html5QrCode.scanFile(file, true)
    .then(text => {
      scannedData = text;
      result.innerHTML = "<b>Data dari Foto:</b><br>" + text;
      kirimBtn.style.display = batalBtn.style.display = "inline-block";
    })
    .catch(() => {
      result.innerHTML = "<span style='color:red'>‚ùå Barcode tidak terbaca</span>";
    });
};

// üîπ KIRIM
kirimBtn.onclick = () => {
  if (!kelas.value) return alert("Pilih kelas dulu!");
  const tgl = new Date().toLocaleDateString("id-ID");
  const url = `${scriptURLs[kelas.value]}?nama=${encodeURIComponent(scannedData)}&tanggal=${tgl}`;

  result.innerHTML = "‚è≥ Mengirim data...";
  fetch(url).then(()=>{
    result.innerHTML = "‚úÖ Presensi berhasil!";
    rescanBtn.style.display = "inline-block";
  });
};

batalBtn.onclick = () => location.reload();
rescanBtn.onclick = () => location.reload();

startScanner();

// üîπ FULLSCREEN
const fsBtn = document.getElementById("fullscreenBtn");
fsBtn.onclick = () => {
  document.fullscreenElement
    ? document.exitFullscreen()
    : document.documentElement.requestFullscreen();
};
</script>

</body>
</html>
